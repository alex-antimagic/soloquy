{% extends "layouts/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Support Tickets</h2>
            <p class="text-muted mb-0">Manage and track all support tickets</p>
        </div>
        <a href="{{ url_for('support.new_ticket') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Ticket
        </a>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" name="search" placeholder="Search tickets..." value="{{ current_filters.search or '' }}">
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="status">
                        <option value="">All Statuses</option>
                        <option value="new" {% if current_filters.status == 'new' %}selected{% endif %}>New</option>
                        <option value="open" {% if current_filters.status == 'open' %}selected{% endif %}>Open</option>
                        <option value="pending" {% if current_filters.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="on_hold" {% if current_filters.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                        <option value="resolved" {% if current_filters.status == 'resolved' %}selected{% endif %}>Resolved</option>
                        <option value="closed" {% if current_filters.status == 'closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="priority">
                        <option value="">All Priorities</option>
                        <option value="low" {% if current_filters.priority == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if current_filters.priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if current_filters.priority == 'high' %}selected{% endif %}>High</option>
                        <option value="urgent" {% if current_filters.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="assignee">
                        <option value="">All Assignees</option>
                        <option value="unassigned" {% if current_filters.assignee == 'unassigned' %}selected{% endif %}>Unassigned</option>
                        {% for agent in agents %}
                        <option value="{{ agent.id }}" {% if current_filters.assignee == agent.id|string %}selected{% endif %}>{{ agent.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tickets Table -->
    {% if tickets %}
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Ticket #</th>
                        <th>Subject</th>
                        <th>Requester</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Assignee</th>
                        <th>Created</th>
                        <th>Updated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ticket in tickets %}
                    <tr onclick="window.location.href='{{ url_for('support.ticket_detail', ticket_id=ticket.id) }}'" style="cursor: pointer;">
                        <td><strong>{{ ticket.ticket_number }}</strong></td>
                        <td>
                            {{ ticket.subject }}
                            {% if ticket.comment_count > 0 %}
                            <span class="badge bg-secondary">{{ ticket.comment_count }}</span>
                            {% endif %}
                        </td>
                        <td>{{ ticket.requester_display_name }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if ticket.status == 'resolved' else 'info' if ticket.status == 'open' else 'warning' if ticket.status == 'pending' else 'secondary' }}">
                                {{ ticket.status.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'danger' if ticket.priority == 'urgent' else 'warning' if ticket.priority == 'high' else 'primary' if ticket.priority == 'medium' else 'secondary' }}">
                                {{ ticket.priority.title() }}
                            </span>
                        </td>
                        <td>{{ ticket.assignee.full_name if ticket.assignee else '-' }}</td>
                        <td>{{ ticket.created_at.strftime('%b %d, %Y') }}</td>
                        <td>{{ ticket.updated_at.strftime('%b %d, %Y') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
            <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}">Previous</a></li>
            {% endif %}
            {% for page in pagination.iter_pages() %}
                {% if page %}
                <li class="page-item {% if page == pagination.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ page }}">{{ page }}</a>
                </li>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-ticket-detailed fs-1 d-block mb-3"></i>
            <h5>No tickets found</h5>
            <p class="text-muted">Try adjusting your filters or create a new ticket</p>
            <a href="{{ url_for('support.new_ticket') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Ticket
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
