{% extends "layouts/base.html" %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if not current_tenant %}
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-building fs-1 mb-3"></i>
                        <h2>Welcome to worklead!</h2>
                        <p class="text-muted mb-4">Get started by creating your first business workspace.</p>
                        <a href="{{ url_for('tenant.create') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle"></i> Create Workspace
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Overdue Tasks Alert -->
        {% if overdue_count > 0 %}
        <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>{{ overdue_count }} overdue task{{ 's' if overdue_count != 1 }}</strong>
            <a href="{{ url_for('tasks.index') }}" class="alert-link ms-2">
                View overdue tasks â†’
            </a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <!-- Dashboard Overview -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-diagram-3 fs-2 text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 text-muted">Departments</h6>
                                <h3 class="mb-0">{{ departments|length }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-people fs-2 text-success"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 text-muted">Team Members</h6>
                                <h3 class="mb-0">{{ current_tenant.get_members()|length }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-robot fs-2 text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 text-muted">AI Agents</h6>
                                <h3 class="mb-0">{{ total_agents }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-check2-circle fs-2 text-warning"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 text-muted">Active Tasks</h6>
                                <h3 class="mb-0">{{ active_tasks_count }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Actions -->
        <div class="row g-3">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Analytics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Tasks Overview Chart -->
                            {% if task_stats and (task_stats.pending + task_stats.in_progress + task_stats.completed) > 0 %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-3">Tasks Overview</h6>
                                <canvas id="tasksChart" style="max-height: 250px;"></canvas>
                            </div>
                            {% endif %}

                            <!-- CRM Pipeline Chart -->
                            {% if deal_pipeline and deal_pipeline|length > 0 %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-3">Sales Pipeline</h6>
                                <canvas id="pipelineChart" style="max-height: 250px;"></canvas>
                            </div>
                            {% endif %}

                            {% if not task_stats and not deal_pipeline %}
                            <div class="col-12">
                                <p class="text-muted text-center py-4">
                                    <i class="bi bi-graph-up fs-1 d-block mb-2"></i>
                                    No analytics data yet. Start by creating tasks or deals!
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- My Tasks Widget -->
                {% if user_tasks is defined %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>My Tasks</h5>
                        <a href="{{ url_for('tasks.index') }}" class="btn btn-sm btn-outline-primary">
                            View All
                        </a>
                    </div>
                    <div class="card-body p-0">
                        {% if user_tasks %}
                        <div class="list-group list-group-flush">
                            {% for task in user_tasks %}
                            <a href="{{ url_for('tasks.view', task_id=task.id) }}"
                               class="list-group-item list-group-item-action {% if task.is_overdue() %}border-start border-danger border-3{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 {% if task.is_overdue() %}text-danger fw-bold{% endif %}">
                                            {{ task.title }}
                                        </h6>
                                        {% if task.project %}
                                        <small class="text-muted">
                                            <i class="bi bi-folder me-1"></i>{{ task.project.name }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end ms-3" style="min-width: 120px;">
                                        <span class="badge {{ task.get_priority_badge_class() }} mb-1 d-block">
                                            {{ task.priority|capitalize }}
                                        </span>
                                        <span class="badge {{ task.get_status_badge_class() }} d-block">
                                            {{ task.status|replace('_', ' ')|title }}
                                        </span>
                                        {% if task.due_date %}
                                        <div class="small {% if task.is_overdue() %}text-danger fw-bold{% else %}text-muted{% endif %} mt-1">
                                            <i class="bi bi-calendar-event me-1"></i>{{ task.due_date.strftime('%b %d, %Y') }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-check-circle fs-1 mb-2 d-block"></i>
                            <p class="mb-0">No tasks assigned to you</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_activity %}
                        <div class="list-group list-group-flush">
                            {% for activity in recent_activity %}
                            <div class="list-group-item px-0">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="bi bi-{{ activity.icon }} text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        {% if activity.url %}
                                        <a href="{{ activity.url }}" class="text-decoration-none">{{ activity.text }}</a>
                                        {% else %}
                                        <span>{{ activity.text }}</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">{{ activity.time.strftime('%b %d, %Y at %I:%M %p') }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">No recent activity yet. Start by creating departments and inviting team members!</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- This Week Summary -->
                {% if tasks_by_date is defined and (tasks_by_date.today or tasks_by_date.tomorrow or tasks_by_date.this_week) %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>This Week</h5>
                    </div>
                    <div class="card-body">
                        {% if tasks_by_date.today %}
                        <div class="mb-3">
                            <h6 class="text-danger mb-2">
                                <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>Today
                            </h6>
                            <ul class="list-unstyled ms-3 mb-0">
                                {% for task in tasks_by_date.today %}
                                <li class="mb-2">
                                    <a href="{{ url_for('tasks.view', task_id=task.id) }}" class="text-decoration-none">
                                        {{ task.title }}
                                    </a>
                                    <span class="badge {{ task.get_priority_badge_class() }} badge-sm ms-2">{{ task.priority }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if tasks_by_date.tomorrow %}
                        <div class="mb-3">
                            <h6 class="text-warning mb-2">
                                <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>Tomorrow
                            </h6>
                            <ul class="list-unstyled ms-3 mb-0">
                                {% for task in tasks_by_date.tomorrow %}
                                <li class="mb-2">
                                    <a href="{{ url_for('tasks.view', task_id=task.id) }}" class="text-decoration-none">
                                        {{ task.title }}
                                    </a>
                                    <span class="badge {{ task.get_priority_badge_class() }} badge-sm ms-2">{{ task.priority }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if tasks_by_date.this_week %}
                        <div>
                            <h6 class="text-info mb-2">
                                <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>This Week
                            </h6>
                            <ul class="list-unstyled ms-3 mb-0">
                                {% for task in tasks_by_date.this_week %}
                                <li class="mb-2">
                                    <a href="{{ url_for('tasks.view', task_id=task.id) }}" class="text-decoration-none">
                                        {{ task.title }}
                                    </a>
                                    <span class="badge {{ task.get_priority_badge_class() }} badge-sm ms-2">{{ task.priority }}</span>
                                    <small class="text-muted ms-2">{{ task.due_date.strftime('%b %d') }}</small>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <!-- Quick Task Creation -->
                        {% if 'tasks' in enabled_applets or 'projects' in enabled_applets %}
                        <button class="list-group-item list-group-item-action" onclick="showQuickTaskModal()">
                            <i class="bi bi-plus-circle me-2 text-success"></i> Quick Add Task
                        </button>
                        <div class="dropdown-divider"></div>
                        {% endif %}

                        <!-- Core Actions -->
                        <a href="{{ url_for('department.create') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-diagram-3 me-2 text-primary"></i> Create Department
                        </a>
                        <a href="{{ url_for('tenant.create_agent') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-robot me-2 text-info"></i> Create AI Agent
                        </a>
                        <a href="{{ url_for('tenant.invite') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-person-plus me-2 text-success"></i> Invite Team Member
                        </a>

                        <div class="dropdown-divider"></div>

                        <!-- CRM Actions -->
                        {% if 'crm' in enabled_applets %}
                        <a href="{{ url_for('crm.leads') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-trophy me-2 text-warning"></i> Create Lead
                        </a>
                        <a href="{{ url_for('crm.contacts') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-person-vcard me-2 text-secondary"></i> Add Contact
                        </a>
                        <a href="{{ url_for('crm.companies') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-building me-2 text-primary"></i> Add Company
                        </a>
                        <a href="{{ url_for('crm.deals') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-currency-dollar me-2 text-success"></i> Create Deal
                        </a>
                        <div class="dropdown-divider"></div>
                        {% endif %}

                        <!-- Tasks & Projects -->
                        {% if 'tasks' in enabled_applets or 'projects' in enabled_applets %}
                        <a href="{{ url_for('tasks.create') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-check2-square me-2 text-info"></i> Create Task
                        </a>
                        <a href="{{ url_for('projects.create') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-kanban me-2 text-warning"></i> Create Project
                        </a>
                        <div class="dropdown-divider"></div>
                        {% endif %}

                        <!-- Support -->
                        {% if 'support' in enabled_applets %}
                        <a href="{{ url_for('support.create_ticket') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-ticket-perforated me-2 text-danger"></i> Create Ticket
                        </a>
                        <div class="dropdown-divider"></div>
                        {% endif %}

                        <!-- Integrations -->
                        <a href="{{ url_for('integrations.index') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-plug me-2 text-secondary"></i> Setup Integration
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Quick Task Creation Modal -->
<div class="modal fade" id="quickTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Add Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quick-task-form">
                    <div class="mb-3">
                        <label for="quick-task-title" class="form-label">Task Title *</label>
                        <input type="text" class="form-control" id="quick-task-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick-task-due-date" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="quick-task-due-date">
                    </div>
                    <div class="mb-3">
                        <label for="quick-task-priority" class="form-label">Priority</label>
                        <select class="form-select" id="quick-task-priority">
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div id="quick-task-error" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createQuickTask()">
                    <i class="bi bi-plus-circle"></i> Create Task
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Tasks Overview Donut Chart
    {% if task_stats and (task_stats.pending + task_stats.in_progress + task_stats.completed) > 0 %}
    const tasksCtx = document.getElementById('tasksChart');
    if (tasksCtx) {
        new Chart(tasksCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'In Progress', 'Completed'],
                datasets: [{
                    data: [
                        {{ task_stats.pending }},
                        {{ task_stats.in_progress }},
                        {{ task_stats.completed }}
                    ],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',  // warning/yellow
                        'rgba(13, 110, 253, 0.8)',  // primary/blue
                        'rgba(25, 135, 84, 0.8)'   // success/green
                    ],
                    borderColor: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(13, 110, 253, 1)',
                        'rgba(25, 135, 84, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#adb5bd',
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // CRM Sales Pipeline Bar Chart
    {% if deal_pipeline and deal_pipeline|length > 0 %}
    const pipelineCtx = document.getElementById('pipelineChart');
    if (pipelineCtx) {
        new Chart(pipelineCtx, {
            type: 'bar',
            data: {
                labels: {{ deal_pipeline|map(attribute='stage')|list|tojson }},
                datasets: [{
                    label: 'Deal Value ($)',
                    data: {{ deal_pipeline|map(attribute='amount')|list|tojson }},
                    backgroundColor: 'rgba(13, 110, 253, 0.8)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',  // Horizontal bar chart
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.x;
                                return `$${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#adb5bd',
                            callback: function(value) {
                                return '$' + value.toLocaleString('en-US');
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#adb5bd'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});

// Quick Task Creation Functions
function showQuickTaskModal() {
    const modal = new bootstrap.Modal(document.getElementById('quickTaskModal'));
    // Reset form
    document.getElementById('quick-task-form').reset();
    document.getElementById('quick-task-error').classList.add('d-none');
    modal.show();
}

async function createQuickTask() {
    const title = document.getElementById('quick-task-title').value.trim();
    const dueDate = document.getElementById('quick-task-due-date').value;
    const priority = document.getElementById('quick-task-priority').value;
    const errorDiv = document.getElementById('quick-task-error');

    // Validation
    if (!title) {
        errorDiv.textContent = 'Task title is required';
        errorDiv.classList.remove('d-none');
        return;
    }

    errorDiv.classList.add('d-none');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch('/tasks/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                title: title,
                due_date: dueDate || null,
                priority: priority,
                status: 'pending'
            })
        });

        if (response.ok) {
            const data = await response.json();
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('quickTaskModal')).hide();
            // Redirect to the new task
            if (data.id) {
                window.location.href = `/tasks/${data.id}`;
            } else {
                window.location.reload();
            }
        } else {
            const data = await response.json();
            errorDiv.textContent = data.error || 'Failed to create task';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error creating task:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
    }
}
</script>
{% endblock %}
