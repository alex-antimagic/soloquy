{% extends "layouts/base.html" %}

{% block head %}
{{ super() }}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .task-card {
        border-left: 4px solid;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .task-card:hover {
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .task-card.priority-high {
        border-left-color: #dc3545;
    }
    .task-card.priority-medium {
        border-left-color: #ffc107;
    }
    .task-card.priority-low {
        border-left-color: #28a745;
    }
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 500px;
    }
    .kanban-header {
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }
    #calendar {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
    }
    .fc-event {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-check2-square me-2"></i>Tasks & Projects</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                    <i class="bi bi-plus-circle"></i> Create Task
                </button>
            </div>
        </div>
    </div>

    <!-- View Tabs -->
    <ul class="nav nav-tabs mb-4" id="taskViewTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab">
                <i class="bi bi-list-ul"></i> List
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="board-tab" data-bs-toggle="tab" data-bs-target="#board-view" type="button" role="tab">
                <i class="bi bi-kanban"></i> Board
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view" type="button" role="tab">
                <i class="bi bi-calendar3"></i> Calendar
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="taskViewContent">
        <!-- List View -->
        <div class="tab-pane fade show active" id="list-view" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-3">
                    <select class="form-select" id="filterPriority">
                        <option value="">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="todo">To Do</option>
                        <option value="in_progress">In Progress</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterProject">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchTasks" placeholder="Search tasks...">
                </div>
            </div>

            <div id="tasksList">
                {% for task in tasks %}
                <div class="card task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}" data-priority="{{ task.priority }}" data-status="{{ task.status }}" data-project="{{ task.project_id or '' }}" data-assigned-to-id="{{ task.assigned_to_id or '' }}" data-assigned-to-agent-id="{{ task.assigned_to_agent_id or '' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="mb-1">
                                    {{ task.title }}
                                    {% if task.status == 'done' %}
                                    <i class="bi bi-check-circle-fill text-success ms-2"></i>
                                    {% endif %}
                                </h5>
                                {% if task.description %}
                                <p class="text-muted mb-2">{{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}</p>
                                {% endif %}
                                <div class="d-flex gap-3 align-items-center">
                                    <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }}">
                                        {{ task.priority|upper }}
                                    </span>
                                    <span class="badge bg-{{ 'secondary' if task.status == 'todo' else 'primary' if task.status == 'in_progress' else 'success' }}">
                                        {{ task.status|replace('_', ' ')|title }}
                                    </span>
                                    {% if task.due_date %}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar-event"></i> Due {{ task.due_date.strftime('%b %d, %Y') }}
                                    </small>
                                    {% endif %}
                                    {% if task.assigned_to %}
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> {{ task.assigned_to.full_name }}
                                    </small>
                                    {% endif %}
                                    {% if task.story_points %}
                                    <small class="text-muted">
                                        <i class="bi bi-star"></i> {{ task.story_points }} pts
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="editTask({{ task.id }})"><i class="bi bi-pencil"></i> Edit</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleComplete({{ task.id }})"><i class="bi bi-check-square"></i> Toggle Complete</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTask({{ task.id }})"><i class="bi bi-trash"></i> Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-3">No tasks yet. Create your first task!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Board View -->
        <div class="tab-pane fade" id="board-view" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <i class="bi bi-circle text-secondary"></i> To Do
                            <span class="badge bg-secondary float-end">{{ tasks|selectattr('status', 'equalto', 'todo')|list|length }}</span>
                        </div>
                        <div class="kanban-tasks" id="todo-column">
                            {% for task in tasks %}
                            {% if task.status == 'todo' %}
                            <div class="card task-card priority-{{ task.priority }} mb-2" data-task-id="{{ task.id }}">
                                <div class="card-body">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.description %}
                                    <p class="small text-muted mb-2">{{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}</p>
                                    {% endif %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }} small">
                                            {{ task.priority|upper }}
                                        </span>
                                        {% if task.due_date %}
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-event"></i> {{ task.due_date.strftime('%m/%d') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <i class="bi bi-circle-fill text-primary"></i> In Progress
                            <span class="badge bg-primary float-end">{{ tasks|selectattr('status', 'equalto', 'in_progress')|list|length }}</span>
                        </div>
                        <div class="kanban-tasks" id="in-progress-column">
                            {% for task in tasks %}
                            {% if task.status == 'in_progress' %}
                            <div class="card task-card priority-{{ task.priority }} mb-2" data-task-id="{{ task.id }}">
                                <div class="card-body">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.description %}
                                    <p class="small text-muted mb-2">{{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}</p>
                                    {% endif %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }} small">
                                            {{ task.priority|upper }}
                                        </span>
                                        {% if task.due_date %}
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-event"></i> {{ task.due_date.strftime('%m/%d') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <i class="bi bi-check-circle-fill text-success"></i> Done
                            <span class="badge bg-success float-end">{{ tasks|selectattr('status', 'equalto', 'done')|list|length }}</span>
                        </div>
                        <div class="kanban-tasks" id="done-column">
                            {% for task in tasks %}
                            {% if task.status == 'done' %}
                            <div class="card task-card priority-{{ task.priority }} mb-2" data-task-id="{{ task.id }}">
                                <div class="card-body">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.description %}
                                    <p class="small text-muted mb-2">{{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}</p>
                                    {% endif %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }} small">
                                            {{ task.priority|upper }}
                                        </span>
                                        {% if task.completed_at %}
                                        <small class="text-muted">
                                            <i class="bi bi-check-circle"></i> {{ task.completed_at.strftime('%m/%d') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="tab-pane fade" id="calendar-view" role="tabpanel">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateTaskDescription('create')">
                                <i class="bi bi-magic"></i> Generate User Story
                            </button>
                            <small class="text-muted align-self-center">AI-powered by Parker (Product)</small>
                        </div>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="taskPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskDueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="taskDueDate">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskProject" class="form-label">Project</label>
                            <select class="form-select" id="taskProject">
                                <option value="">None</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskAssignedTo" class="form-label">Assign To</label>
                            <select class="form-select" id="taskAssignedTo">
                                <option value="">Unassigned</option>
                                <optgroup label="Team Members">
                                    {% for member in team_members %}
                                    <option value="user_{{ member.id }}">{{ member.full_name }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="AI Agents">
                                    {% for agent in agents %}
                                    <option value="agent_{{ agent.id }}">{{ agent.name }} ({{ agent.department.name }})</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskStoryPoints" class="form-label">Story Points</label>
                            <input type="number" class="form-control" id="taskStoryPoints" min="1" max="100">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label for="editTaskTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="editTaskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskDescription" class="form-label">Description</label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateTaskDescription('edit')">
                                <i class="bi bi-magic"></i> Generate User Story
                            </button>
                            <small class="text-muted align-self-center">AI-powered by Parker (Product)</small>
                        </div>
                        <textarea class="form-control" id="editTaskDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="editTaskPriority">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTaskDueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="editTaskDueDate">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskProject" class="form-label">Project</label>
                            <select class="form-select" id="editTaskProject">
                                <option value="">None</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTaskAssignedTo" class="form-label">Assign To</label>
                            <select class="form-select" id="editTaskAssignedTo">
                                <option value="">Unassigned</option>
                                <optgroup label="Team Members">
                                    {% for member in team_members %}
                                    <option value="user_{{ member.id }}">{{ member.full_name }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="AI Agents">
                                    {% for agent in agents %}
                                    <option value="agent_{{ agent.id }}">{{ agent.name }} ({{ agent.department.name }})</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskStoryPoints" class="form-label">Story Points</label>
                            <input type="number" class="form-control" id="editTaskStoryPoints" min="1" max="100">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
let calendar;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize FullCalendar
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: [
            {% for task in tasks %}
            {% if task.due_date %}
            {
                id: '{{ task.id }}',
                title: '{{ task.title|replace("'", "\\'") }}',
                start: '{{ task.due_date.strftime('%Y-%m-%d') }}',
                color: '{{ "#dc3545" if task.priority == "high" else "#ffc107" if task.priority == "medium" else "#28a745" }}',
                extendedProps: {
                    status: '{{ task.status }}',
                    priority: '{{ task.priority }}',
                    description: '{{ task.description|replace("'", "\\'")|replace("\n", " ") if task.description else "" }}'
                }
            },
            {% endif %}
            {% endfor %}
        ],
        eventClick: function(info) {
            const task = info.event;
            alert(`Task: ${task.title}\nPriority: ${task.extendedProps.priority}\nStatus: ${task.extendedProps.status}\nDescription: ${task.extendedProps.description || 'No description'}`);
        }
    });
    calendar.render();

    // List view filtering
    const filterPriority = document.getElementById('filterPriority');
    const filterStatus = document.getElementById('filterStatus');
    const filterProject = document.getElementById('filterProject');
    const searchTasks = document.getElementById('searchTasks');

    function filterTasks() {
        const priorityValue = filterPriority.value;
        const statusValue = filterStatus.value;
        const projectValue = filterProject.value;
        const searchValue = searchTasks.value.toLowerCase();

        document.querySelectorAll('#tasksList .task-card').forEach(card => {
            const priority = card.dataset.priority;
            const status = card.dataset.status;
            const project = card.dataset.project;
            const title = card.querySelector('h5').textContent.toLowerCase();

            let show = true;

            if (priorityValue && priority !== priorityValue) show = false;
            if (statusValue && status !== statusValue) show = false;
            if (projectValue && project !== projectValue) show = false;
            if (searchValue && !title.includes(searchValue)) show = false;

            card.style.display = show ? 'block' : 'none';
        });
    }

    filterPriority.addEventListener('change', filterTasks);
    filterStatus.addEventListener('change', filterTasks);
    filterProject.addEventListener('change', filterTasks);
    searchTasks.addEventListener('input', filterTasks);
});

function createTask() {
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const priority = document.getElementById('taskPriority').value;
    const dueDate = document.getElementById('taskDueDate').value;
    const projectId = document.getElementById('taskProject').value;
    const storyPoints = document.getElementById('taskStoryPoints').value;
    const assignedTo = document.getElementById('taskAssignedTo').value;

    if (!title) {
        alert('Please enter a task title');
        return;
    }

    // Parse assigned_to value (format: "user_123" or "agent_456")
    let assignedToId = null;
    let assignedToAgentId = null;
    if (assignedTo) {
        if (assignedTo.startsWith('user_')) {
            assignedToId = parseInt(assignedTo.replace('user_', ''));
        } else if (assignedTo.startsWith('agent_')) {
            assignedToAgentId = parseInt(assignedTo.replace('agent_', ''));
        }
    }

    fetch('/tasks/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            priority: priority,
            due_date: dueDate,
            project_id: projectId || null,
            story_points: storyPoints || null,
            assigned_to_id: assignedToId,
            assigned_to_agent_id: assignedToAgentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create task');
    });
}

function editTask(taskId) {
    // Find the task card
    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!taskCard) {
        alert('Task not found');
        return;
    }

    // Extract task data from the card
    const title = taskCard.querySelector('h5').textContent.trim().replace(/\s*âœ“\s*$/, '');
    const descriptionEl = taskCard.querySelector('.text-muted');
    const description = descriptionEl ? descriptionEl.textContent.trim().replace(/\.\.\.$/, '') : '';
    const priority = taskCard.dataset.priority;
    const status = taskCard.dataset.status;

    // Get due date if exists
    const dueDateEl = taskCard.querySelector('.bi-calendar-event');
    let dueDate = '';
    if (dueDateEl && dueDateEl.parentElement) {
        const dueDateText = dueDateEl.parentElement.textContent.trim();
        const dateMatch = dueDateText.match(/Due (.+)/);
        if (dateMatch) {
            const parsedDate = new Date(dateMatch[1]);
            if (!isNaN(parsedDate)) {
                dueDate = parsedDate.toISOString().split('T')[0];
            }
        }
    }

    // Get project if exists
    const projectId = taskCard.dataset.project || '';

    // Get story points if exists
    const storyPointsEl = taskCard.querySelector('.bi-star');
    let storyPoints = '';
    if (storyPointsEl && storyPointsEl.parentElement) {
        const match = storyPointsEl.parentElement.textContent.match(/(\d+) pts/);
        if (match) {
            storyPoints = match[1];
        }
    }

    // Get assigned to (user or agent)
    const assignedToUserId = taskCard.dataset.assignedToId;
    const assignedToAgentId = taskCard.dataset.assignedToAgentId;
    let assignedToValue = '';
    if (assignedToUserId) {
        assignedToValue = `user_${assignedToUserId}`;
    } else if (assignedToAgentId) {
        assignedToValue = `agent_${assignedToAgentId}`;
    }

    // Populate edit modal
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('editTaskTitle').value = title;
    document.getElementById('editTaskDescription').value = description;
    document.getElementById('editTaskPriority').value = priority;
    document.getElementById('editTaskDueDate').value = dueDate;
    document.getElementById('editTaskProject').value = projectId;
    document.getElementById('editTaskStoryPoints').value = storyPoints;
    document.getElementById('editTaskAssignedTo').value = assignedToValue;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
    modal.show();
}

function saveTaskEdit() {
    const taskId = document.getElementById('editTaskId').value;
    const title = document.getElementById('editTaskTitle').value;
    const description = document.getElementById('editTaskDescription').value;
    const priority = document.getElementById('editTaskPriority').value;
    const dueDate = document.getElementById('editTaskDueDate').value;
    const projectId = document.getElementById('editTaskProject').value;
    const storyPoints = document.getElementById('editTaskStoryPoints').value;
    const assignedTo = document.getElementById('editTaskAssignedTo').value;

    if (!title) {
        alert('Please enter a task title');
        return;
    }

    // Parse assigned_to value (format: "user_123" or "agent_456")
    let assignedToId = null;
    let assignedToAgentId = null;
    if (assignedTo) {
        if (assignedTo.startsWith('user_')) {
            assignedToId = parseInt(assignedTo.replace('user_', ''));
        } else if (assignedTo.startsWith('agent_')) {
            assignedToAgentId = parseInt(assignedTo.replace('agent_', ''));
        }
    }

    fetch(`/tasks/${taskId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            priority: priority,
            due_date: dueDate || null,
            project_id: projectId || null,
            story_points: storyPoints || null,
            assigned_to_id: assignedToId,
            assigned_to_agent_id: assignedToAgentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Hide modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update task');
    });
}

function toggleComplete(taskId) {
    fetch(`/tasks/${taskId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to toggle task completion');
    });
}

async function generateTaskDescription(mode) {
    // Get the title from the appropriate form
    const titleId = mode === 'create' ? 'taskTitle' : 'editTaskTitle';
    const descriptionId = mode === 'create' ? 'taskDescription' : 'editTaskDescription';

    const title = document.getElementById(titleId).value.trim();

    if (!title) {
        alert('Please enter a task title first');
        return;
    }

    // Get the button and disable it
    const button = event.target.closest('button');
    const originalButtonContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

    try {
        const response = await fetch('/tasks/generate-description', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title: title })
        });

        const data = await response.json();

        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            document.getElementById(descriptionId).value = data.description;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate description');
    } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = originalButtonContent;
    }
}

function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    fetch(`/tasks/${taskId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete task');
    });
}
</script>
{% endblock %}
