{% extends "layouts/base.html" %}

{% block extra_css %}
<style>
    /* Asana-inspired Task View */
    .task-view-container {
        width: 100%;
        margin: 0;
        padding: 0;
    }

    /* Header */
    .task-header {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color);
        padding: 1.25rem 2rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .task-title-input {
        border: none;
        background: transparent;
        font-size: 1.5rem;
        font-weight: 600;
        padding: 0.25rem 0;
        width: 100%;
        color: var(--bs-body-color);
    }

    .task-title-input:focus {
        outline: none;
        border-bottom: 2px solid var(--bs-primary);
    }

    .task-checkbox {
        width: 1.25rem;
        height: 1.25rem;
        margin-top: 0.5rem;
        cursor: pointer;
        border-radius: 50%;
    }

    /* Main Layout */
    .task-body {
        display: flex;
        min-height: calc(100vh - 200px);
    }

    .task-main {
        flex: 1;
        padding: 2rem;
    }

    .task-sidebar {
        width: 280px;
        padding: 2rem 1.5rem;
        background: var(--bs-secondary-bg);
        border-left: 1px solid var(--bs-border-color);
    }

    /* Sections */
    .task-section {
        margin-bottom: 2rem;
    }

    .task-section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .task-description {
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--bs-body-color);
        min-height: 80px;
        padding: 0.75rem 0;
    }

    .task-description:empty:before {
        content: 'Add description...';
        color: var(--bs-secondary-color);
    }

    /* Sidebar Fields */
    .sidebar-field {
        margin-bottom: 1.25rem;
    }

    .sidebar-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .sidebar-value {
        padding: 0.5rem 0.75rem;
        background: var(--bs-body-bg);
        border-radius: 0.375rem;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 0.875rem;
    }

    .sidebar-value:hover {
        border-color: var(--bs-border-color);
        background: var(--bs-tertiary-bg);
    }

    .sidebar-value.empty {
        color: var(--bs-secondary-color);
    }

    /* Attachments */
    .attachment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
    }

    .attachment-card {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        overflow: hidden;
        transition: all 0.2s;
        background: var(--bs-body-bg);
    }

    .attachment-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .attachment-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }

    .attachment-info {
        padding: 0.5rem;
        font-size: 0.75rem;
    }

    /* Comments */
    .comment-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .comment-avatar:not(img) {
        background: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .comment-avatar img,
    img.comment-avatar {
        object-fit: cover;
    }

    .comment-content {
        flex: 1;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .comment-author {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .comment-time {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
    }

    .comment-text {
        font-size: 0.875rem;
        line-height: 1.5;
        padding: 0.75rem;
        background: var(--bs-secondary-bg);
        border-radius: 0.5rem;
    }

    .comment-input {
        display: flex;
        gap: 0.75rem;
        align-items: start;
        margin-top: 1rem;
    }

    .comment-input textarea {
        flex: 1;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 0.75rem;
        resize: vertical;
        min-height: 80px;
        font-size: 0.875rem;
    }

    /* Breadcrumb */
    .task-breadcrumb {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
        margin-bottom: 1rem;
    }

    .task-breadcrumb a {
        color: var(--bs-secondary-color);
        text-decoration: none;
    }

    .task-breadcrumb a:hover {
        color: var(--bs-link-color);
    }

    /* Upload Button */
    .upload-attachment-btn {
        border: 2px dashed var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
        width: 100%;
    }

    .upload-attachment-btn:hover {
        border-color: var(--bs-primary);
        background: var(--bs-primary-bg-subtle);
    }
</style>
{% endblock %}

{% block content %}
<div class="task-view-container">
    <!-- Header -->
    <div class="task-header">
        <div class="task-breadcrumb">
            <a href="{{ url_for('projects.index') }}">Projects</a>
            {% if task.project %}
            <span class="mx-2">/</span>
            <a href="{{ url_for('projects.view', project_id=task.project_id) }}">{{ task.project.name }}</a>
            {% endif %}
        </div>
        <div class="d-flex align-items-start gap-3">
            <input class="form-check-input task-checkbox" type="checkbox"
                   {% if task.status == 'completed' %}checked{% endif %}
                   data-task-id="{{ task.id }}">
            <input type="text" class="task-title-input" value="{{ task.title }}" id="task-title-input">
            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="deleteTask()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Body -->
    <div class="task-body">
        <!-- Main Content -->
        <div class="task-main">
            <!-- Description -->
            <div class="task-section">
                <div class="task-section-title">Description</div>
                <div class="task-description" contenteditable="true" id="task-description">{{ task.description or '' }}</div>
            </div>

            <!-- Attachments -->
            <div class="task-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="task-section-title mb-0">Attachments</div>
                    <button class="btn btn-sm btn-primary" onclick="showUploadModal()">
                        <i class="bi bi-paperclip"></i> Add
                    </button>
                </div>
                <div id="attachments-container">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <div class="mt-2">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="task-section">
                <div class="task-section-title">Comments</div>
                <div id="comments-container">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <div class="mt-2">Loading...</div>
                    </div>
                </div>

                <!-- Add Comment -->
                <div class="comment-input">
                    {% if current_user.avatar_url %}
                    <img src="{{ current_user.avatar_url }}" class="comment-avatar" alt="{{ current_user.full_name }}">
                    {% else %}
                    <div class="comment-avatar">{{ current_user.full_name[0].upper() if current_user.full_name else 'U' }}</div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <textarea class="form-control" id="new-comment-text" placeholder="Add a comment..."></textarea>
                        <button class="btn btn-sm btn-primary mt-2" onclick="addComment()">
                            Post Comment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="task-sidebar">
            <!-- Assignee -->
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-person"></i> Assignee
                </div>
                <div class="sidebar-value {% if not task.assigned_to %}empty{% endif %}">
                    {% if task.assigned_to %}
                        {{ task.assigned_to.full_name }}
                    {% elif task.assigned_to_agent %}
                        <i class="bi bi-robot"></i> {{ task.assigned_to_agent.name }}
                    {% else %}
                        Unassigned
                    {% endif %}
                </div>
            </div>

            <!-- Due Date -->
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-calendar3"></i> Due Date
                </div>
                <div class="sidebar-value {% if not task.due_date %}empty{% endif %} {% if task.is_overdue() %}text-danger{% endif %}">
                    {% if task.due_date %}
                        {{ task.due_date.strftime('%b %d, %Y') }}
                        {% if task.is_overdue() %}<i class="bi bi-exclamation-circle ms-1"></i>{% endif %}
                    {% else %}
                        No due date
                    {% endif %}
                </div>
            </div>

            <!-- Priority -->
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-flag"></i> Priority
                </div>
                <div class="sidebar-value">
                    <span class="badge {{ task.get_priority_badge_class() }}">{{ task.priority }}</span>
                </div>
            </div>

            <!-- Status -->
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-check-circle"></i> Status
                </div>
                <div class="sidebar-value">
                    <span class="badge {{ task.get_status_badge_class() }}">{{ task.status }}</span>
                </div>
            </div>

            <!-- Project -->
            {% if task.project %}
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-folder"></i> Project
                </div>
                <div class="sidebar-value">
                    {{ task.project.name }}
                </div>
            </div>
            {% endif %}

            <!-- Story Points -->
            {% if task.story_points %}
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-star"></i> Story Points
                </div>
                <div class="sidebar-value">
                    {{ task.story_points }}
                </div>
            </div>
            {% endif %}

            <!-- Tags -->
            {% if task.get_tag_list()|length > 0 %}
            <div class="sidebar-field">
                <div class="sidebar-label">
                    <i class="bi bi-tags"></i> Tags
                </div>
                <div class="d-flex flex-wrap gap-1">
                    {% for tag in task.get_tag_list() %}
                    <span class="badge bg-secondary">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Created -->
            <div class="sidebar-field mt-4 pt-3" style="border-top: 1px solid var(--bs-border-color);">
                <div class="sidebar-label mb-1">Created</div>
                <div class="text-muted small">{{ task.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
            </div>

            <!-- Last Updated -->
            {% if task.updated_at %}
            <div class="sidebar-field">
                <div class="sidebar-label mb-1">Last Updated</div>
                <div class="text-muted small">{{ task.updated_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Attachment Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="attachmentFile" class="form-label">Select File</label>
                    <input type="file" class="form-control" id="attachmentFile" accept="*/*">
                    <div class="form-text">Maximum file size: 10MB</div>
                </div>
                <div id="upload-progress" class="d-none">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mt-2 mb-0">Uploading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadAttachment()" id="upload-btn">
                    <i class="bi bi-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const taskId = {{ task.id }};

// Load attachments and comments
loadAttachments();
loadComments();

// Attachment Management Functions (from existing code)
async function loadAttachments() {
    try {
        const response = await fetch(`/tasks/${taskId}/attachments`);
        const data = await response.json();

        if (response.ok) {
            const taskAttachments = data.task_attachments || [];
            const totalCount = data.total_count || 0;

            if (totalCount === 0) {
                document.getElementById('attachments-container').innerHTML =
                    '<div class="text-muted text-center py-3">No attachments</div>';
                return;
            }

            let html = '<div class="attachment-grid">';
            taskAttachments.forEach(att => {
                if (att.is_image) {
                    html += `
                        <div class="attachment-card" ondblclick="window.open('${att.file_path}', '_blank')" style="cursor: pointer;">
                            <img src="${att.file_path}" class="attachment-image" alt="${escapeHtml(att.filename)}">
                            <div class="attachment-info">
                                <div class="text-truncate fw-semibold">${escapeHtml(att.filename)}</div>
                                <div class="text-muted">${att.file_size_display}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="attachment-card p-3" ondblclick="window.open('${att.file_path}', '_blank')" style="cursor: pointer;">
                            <i class="bi ${att.icon_class} fs-1 text-primary d-block mb-2"></i>
                            <div class="text-truncate fw-semibold small">${escapeHtml(att.filename)}</div>
                            <div class="text-muted small">${att.file_size_display}</div>
                        </div>
                    `;
                }
            });
            html += '</div>';

            document.getElementById('attachments-container').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading attachments:', error);
    }
}

async function loadComments() {
    try {
        const response = await fetch(`/tasks/${taskId}/comments`);
        const data = await response.json();

        if (response.ok) {
            const comments = data.comments || [];

            if (comments.length === 0) {
                document.getElementById('comments-container').innerHTML = '';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                const initials = comment.author_name ? comment.author_name[0].toUpperCase() : 'U';
                const timeAgo = new Date(comment.created_at).toLocaleString();

                // Use avatar URL if available, otherwise show initials
                let avatarHtml = '';
                if (comment.author_avatar) {
                    avatarHtml = `<img src="${escapeHtml(comment.author_avatar)}" class="comment-avatar" alt="${escapeHtml(comment.author_name || 'User')}">`;
                } else {
                    avatarHtml = `<div class="comment-avatar">${initials}</div>`;
                }

                html += `
                    <div class="comment-item">
                        ${avatarHtml}
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(comment.author_name || 'Unknown')}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('comments-container').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

async function addComment() {
    const commentText = document.getElementById('new-comment-text').value.trim();
    if (!commentText) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tasks/${taskId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ comment_text: commentText })
        });

        if (response.ok) {
            document.getElementById('new-comment-text').value = '';
            await loadComments();
        }
    } catch (error) {
        console.error('Error adding comment:', error);
    }
}

function showUploadModal() {
    const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    document.getElementById('attachmentFile').value = '';
    document.getElementById('upload-progress').classList.add('d-none');
    uploadModal.show();
}

async function uploadAttachment() {
    const fileInput = document.getElementById('attachmentFile');
    const file = fileInput.files[0];
    if (!file) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const formData = new FormData();
    formData.append('file', file);

    document.getElementById('upload-progress').classList.remove('d-none');
    document.getElementById('upload-btn').disabled = true;

    try {
        const response = await fetch(`/tasks/${taskId}/attachments/upload`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            await loadAttachments();
        }
    } catch (error) {
        console.error('Error uploading file:', error);
    } finally {
        document.getElementById('upload-progress').classList.add('d-none');
        document.getElementById('upload-btn').disabled = false;
    }
}

async function deleteTask() {
    if (!confirm('Delete this task? This cannot be undone.')) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        if (response.ok) {
            window.location.href = '{{ url_for("projects.index") }}';
        }
    } catch (error) {
        console.error('Error deleting task:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Task completion checkbox
document.querySelector('.task-checkbox').addEventListener('change', async function() {
    const isChecked = this.checked;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tasks/${taskId}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ completed: isChecked })
        });

        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error updating task:', error);
        this.checked = !isChecked;
    }
});

// Inline editing for title
const titleInput = document.getElementById('task-title-input');
let originalTitle = titleInput.value;

titleInput.addEventListener('focus', function() {
    originalTitle = this.value;
});

titleInput.addEventListener('blur', async function() {
    await saveTitle();
});

titleInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        this.blur();
    } else if (e.key === 'Escape') {
        this.value = originalTitle;
        this.blur();
    }
});

async function saveTitle() {
    const newTitle = titleInput.value.trim();

    if (!newTitle) {
        titleInput.value = originalTitle;
        return;
    }

    if (newTitle === originalTitle) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tasks/${taskId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ title: newTitle })
        });

        if (response.ok) {
            originalTitle = newTitle;
        } else {
            titleInput.value = originalTitle;
        }
    } catch (error) {
        console.error('Error updating title:', error);
        titleInput.value = originalTitle;
    }
}

// Inline editing for description
const descriptionDiv = document.getElementById('task-description');
let originalDescription = descriptionDiv.textContent;

descriptionDiv.addEventListener('focus', function() {
    originalDescription = this.textContent;
});

descriptionDiv.addEventListener('blur', async function() {
    await saveDescription();
});

async function saveDescription() {
    const newDescription = descriptionDiv.textContent.trim();

    if (newDescription === originalDescription) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/tasks/${taskId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ description: newDescription })
        });

        if (response.ok) {
            originalDescription = newDescription;
        } else {
            descriptionDiv.textContent = originalDescription;
        }
    } catch (error) {
        console.error('Error updating description:', error);
        descriptionDiv.textContent = originalDescription;
    }
}
</script>
{% endblock %}
