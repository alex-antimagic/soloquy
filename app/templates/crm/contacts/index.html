{% extends "layouts/base.html" %}

{% block extra_css %}
<style>
    .contact-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .contact-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .contact-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Contacts</h2>
            <p class="text-muted mb-0">Manage your individual contacts and leads</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importContactModal">
                <i class="bi bi-upload"></i> Import CSV
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createContactModal">
                <i class="bi bi-person-plus"></i> New Contact
            </button>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('crm.contacts') }}" class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="search" placeholder="Search contacts..." value="{{ search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="lifecycle_stage">
                        <option value="">All Stages</option>
                        <option value="subscriber" {% if lifecycle_stage == 'subscriber' %}selected{% endif %}>Subscriber</option>
                        <option value="lead" {% if lifecycle_stage == 'lead' %}selected{% endif %}>Lead</option>
                        <option value="marketing_qualified" {% if lifecycle_stage == 'marketing_qualified' %}selected{% endif %}>Marketing Qualified</option>
                        <option value="sales_qualified" {% if lifecycle_stage == 'sales_qualified' %}selected{% endif %}>Sales Qualified</option>
                        <option value="opportunity" {% if lifecycle_stage == 'opportunity' %}selected{% endif %}>Opportunity</option>
                        <option value="customer" {% if lifecycle_stage == 'customer' %}selected{% endif %}>Customer</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="company_id">
                        <option value="">All Companies</option>
                        {% for company in companies %}
                        <option value="{{ company.id }}" {% if company_id == company.id|string %}selected{% endif %}>{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contacts List -->
    {% if contacts %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for contact in contacts %}
        <div class="col">
            <div class="card h-100 contact-card" style="cursor: pointer;" onclick="window.location.href='{{ url_for('crm.contact_detail', contact_id=contact.id) }}'">
                <div class="card-body">
                    <div class="d-flex align-items-start gap-3 mb-3">
                        <div class="contact-avatar">
                            {{ contact.first_name[0] }}{{ contact.last_name[0] }}
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">{{ contact.first_name }} {{ contact.last_name }}</h5>
                            {% if contact.job_title %}
                            <p class="text-muted small mb-1">{{ contact.job_title }}</p>
                            {% endif %}
                            {% if contact.company %}
                            <p class="text-muted small mb-0">
                                <i class="bi bi-building"></i> {{ contact.company.name }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="dropdown" onclick="event.stopPropagation();">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('crm.contact_detail', contact_id=contact.id) }}"><i class="bi bi-eye"></i> View Details</a></li>
                                <li><a class="dropdown-item" href="#" onclick="editContact({{ contact.id }}, event)"><i class="bi bi-pencil"></i> Edit</a></li>
                                <li><a class="dropdown-item" href="#" onclick="createDealForContact({{ contact.id }}, event)"><i class="bi bi-currency-dollar"></i> Create Deal</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteContact({{ contact.id }}, event)"><i class="bi bi-trash"></i> Delete</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <span class="badge bg-{{ 'success' if contact.lifecycle_stage == 'customer' else 'info' if contact.lifecycle_stage == 'opportunity' else 'secondary' }}">
                            {{ contact.lifecycle_stage or 'subscriber' }}
                        </span>
                        {% if contact.lead_score > 0 %}
                        <span class="badge bg-warning">Score: {{ contact.lead_score }}</span>
                        {% endif %}
                    </div>

                    {% if contact.email %}
                    <p class="small mb-1">
                        <i class="bi bi-envelope"></i>
                        <a href="mailto:{{ contact.email }}" onclick="event.stopPropagation();">{{ contact.email }}</a>
                    </p>
                    {% endif %}
                    {% if contact.phone %}
                    <p class="small mb-1">
                        <i class="bi bi-telephone"></i>
                        <a href="tel:{{ contact.phone }}" onclick="event.stopPropagation();">{{ contact.phone }}</a>
                    </p>
                    {% endif %}

                    {% if contact.owner %}
                    <div class="mt-3 pt-3 border-top small text-muted">
                        <i class="bi bi-person-badge"></i> {{ contact.owner.full_name }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center text-muted py-5">
            <i class="bi bi-person fs-1 d-block mb-3"></i>
            <h5>No contacts yet</h5>
            <p class="mb-3">Create your first contact to start building your network</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createContactModal">
                <i class="bi bi-person-plus"></i> Add Contact
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Contact Modal -->
<div class="modal fade" id="createContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createContactForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactFirstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="contactFirstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactLastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="contactLastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="contactEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="contactPhone" name="phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactJobTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="contactJobTitle" name="job_title">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactCompany" class="form-label">Company</label>
                            <select class="form-select" id="contactCompany" name="company_id">
                                <option value="">Select company...</option>
                                {% for company in companies %}
                                <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactLifecycleStage" class="form-label">Lifecycle Stage</label>
                            <select class="form-select" id="contactLifecycleStage" name="lifecycle_stage">
                                <option value="subscriber">Subscriber</option>
                                <option value="lead">Lead</option>
                                <option value="marketing_qualified">Marketing Qualified</option>
                                <option value="sales_qualified">Sales Qualified</option>
                                <option value="opportunity">Opportunity</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactLeadScore" class="form-label">Lead Score</label>
                            <input type="number" class="form-control" id="contactLeadScore" name="lead_score" value="0" min="0" max="100">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="contactDescription" class="form-label">Notes</label>
                        <textarea class="form-control" id="contactDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactLinkedin" class="form-label">LinkedIn URL</label>
                            <input type="url" class="form-control" id="contactLinkedin" name="linkedin_url">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactTwitter" class="form-label">Twitter Handle</label>
                            <input type="text" class="form-control" id="contactTwitter" name="twitter_handle" placeholder="@username">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createContact()">Add Contact</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Contacts Modal -->
<div class="modal fade" id="importContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Contacts from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>CSV Format:</strong> Download the template below to see the correct format.
                    Required fields: <strong>first_name, last_name, email</strong>
                </div>

                <div class="mb-3">
                    <a href="{{ url_for('crm.download_contact_template') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-download"></i> Download CSV Template
                    </a>
                </div>

                <div class="mb-3">
                    <label for="contactCSVFile" class="form-label">Select CSV File</label>
                    <input type="file" class="form-control" id="contactCSVFile" accept=".csv">
                </div>

                <div id="importContactResults" class="d-none">
                    <div class="alert alert-success" id="importContactSuccess" style="display: none;">
                        <i class="bi bi-check-circle"></i>
                        <span id="contactSuccessMessage"></span>
                    </div>
                    <div class="alert alert-danger" id="importContactErrors" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Import Errors:</strong>
                        <ul id="contactErrorList" class="mb-0 mt-2"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importContacts()">
                    <i class="bi bi-upload"></i> Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" id="editContactId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactFirstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="editContactFirstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactLastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="editContactLastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editContactEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editContactPhone" name="phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactMobile" class="form-label">Mobile</label>
                            <input type="tel" class="form-control" id="editContactMobile" name="mobile">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactJobTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="editContactJobTitle" name="job_title">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactCompany" class="form-label">Company</label>
                            <select class="form-select" id="editContactCompany" name="company_id">
                                <option value="">Select company...</option>
                                {% for company in companies %}
                                <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactDepartment" class="form-label">Department</label>
                            <input type="text" class="form-control" id="editContactDepartment" name="department">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactLifecycleStage" class="form-label">Lifecycle Stage</label>
                            <select class="form-select" id="editContactLifecycleStage" name="lifecycle_stage">
                                <option value="subscriber">Subscriber</option>
                                <option value="lead">Lead</option>
                                <option value="marketing_qualified">Marketing Qualified</option>
                                <option value="sales_qualified">Sales Qualified</option>
                                <option value="opportunity">Opportunity</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactLeadScore" class="form-label">Lead Score</label>
                            <input type="number" class="form-control" id="editContactLeadScore" name="lead_score" min="0" max="100">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editContactDescription" class="form-label">Notes</label>
                        <textarea class="form-control" id="editContactDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editContactLinkedin" class="form-label">LinkedIn URL</label>
                            <input type="url" class="form-control" id="editContactLinkedin" name="linkedin_url">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContactTwitter" class="form-label">Twitter Handle</label>
                            <input type="text" class="form-control" id="editContactTwitter" name="twitter_handle" placeholder="@username">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateContact()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function createContact() {
    const form = document.getElementById('createContactForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Convert empty strings to null
    Object.keys(data).forEach(key => {
        if (data[key] === '') data[key] = null;
    });

    fetch('{{ url_for("crm.create_contact") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            window.location.href = `/crm/contacts/${data.id}`;
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create contact');
    });
}

function editContact(contactId, event) {
    event.preventDefault();
    event.stopPropagation();

    // Store contactId for update
    document.getElementById('editContactId').value = contactId;

    // Show modal (user will need to fill in current values)
    const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
    modal.show();
}

function updateContact() {
    const contactId = document.getElementById('editContactId').value;
    const form = document.getElementById('editContactForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Convert empty strings to null
    Object.keys(data).forEach(key => {
        if (data[key] === '') data[key] = null;
    });

    fetch(`/crm/contacts/${contactId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editContactModal'));
            modal.hide();
            // Reload page to show updated data
            window.location.reload();
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update contact');
    });
}

function createDealForContact(contactId, event) {
    event.preventDefault();
    event.stopPropagation();
    alert('Create deal functionality coming soon!');
}

function deleteContact(contactId, event) {
    event.preventDefault();
    event.stopPropagation();

    if (confirm('Delete this contact permanently? This cannot be undone.')) {
        fetch(`/crm/contacts/${contactId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete contact');
        });
    }
}

function importContacts() {
    const fileInput = document.getElementById('contactCSVFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a CSV file');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // Show loading state
    const importButton = event.target;
    const originalText = importButton.innerHTML;
    importButton.disabled = true;
    importButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';

    fetch('{{ url_for("crm.import_contacts") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('importContactResults');
        const successDiv = document.getElementById('importContactSuccess');
        const errorsDiv = document.getElementById('importContactErrors');
        const successMessage = document.getElementById('contactSuccessMessage');
        const errorList = document.getElementById('contactErrorList');

        resultsDiv.classList.remove('d-none');

        if (data.success > 0) {
            successDiv.style.display = 'block';
            successMessage.textContent = `Successfully imported ${data.success} contacts!`;
        }

        if (data.errors && data.errors.length > 0) {
            errorsDiv.style.display = 'block';
            errorList.innerHTML = '';
            data.errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = `Row ${error.row}: ${error.error}`;
                errorList.appendChild(li);
            });
        }

        // Reset button
        importButton.disabled = false;
        importButton.innerHTML = originalText;

        // Reload page after 2 seconds if any contacts were imported
        if (data.success > 0) {
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to import contacts');
        importButton.disabled = false;
        importButton.innerHTML = originalText;
    });
}
</script>
{% endblock %}
